<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Honking Narwhals Team 9214</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		
		body {
			font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 100vh;
			padding: 10px;
		}
		
		.container {
			background: white;
			border-radius: 10px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
			padding: 20px;
			max-width: 1200px;
			width: 100%;
		}
		
		h1 {
			text-align: center;
			color: #333;
			margin-bottom: 5px;
			font-size: 24px;
		}
		
		.status-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 10px 0;
			border-bottom: 2px solid #eee;
			margin-bottom: 15px;
			font-size: 13px;
		}
		
		.status {
			display: flex;
			gap: 15px;
		}
		
		.status-item {
			display: flex;
			gap: 5px;
			align-items: center;
		}
		
		#wsStatus {
			font-weight: bold;
			color: #e74c3c;
		}
		
		#wsStatus.connected {
			color: #2ecc71;
		}
		
		.content {
			display: flex;
			gap: 20px;
		}
		
		.left-panel {
			flex: 0 0 250px;
		}
		
		.button {
			display: block;
			width: 100%;
			padding: 10px;
			margin-bottom: 8px;
			border: none;
			border-radius: 5px;
			font-size: 12px;
			font-weight: bold;
			cursor: pointer;
			color: white;
			transition: all 0.3s;
		}
		
		.button:hover {
			opacity: 0.9;
			transform: translateY(-2px);
		}
		
		.button:disabled {
			opacity: 0.6;
			cursor: not-allowed;
		}
		
		.btn-primary { background: #3498db; }
		.btn-success { background: #27ae60; }
		.btn-danger { background: #e74c3c; }
		.btn-warning { background: #f39c12; }
		
		.section {
			background: #f8f9fa;
			border-radius: 5px;
			padding: 12px;
			margin-bottom: 12px;
		}
		
		.section-title {
			font-weight: bold;
			color: #2c3e50;
			margin-bottom: 8px;
			border-bottom: 2px solid #3498db;
			padding-bottom: 5px;
		}
		
		.center-panel {
			flex: 1;
			display: flex;
			flex-direction: column;
			gap: 20px;
		}
		
		.canvas-wrapper {
			position: relative;
			display: inline-block;
		}
		
		canvas {
			border: 1px solid #ccc;
			border-radius: 5px;
			background: white;
			max-width: 100%;
			display: block;
		}
		
		.canvas-angle-box {
			position: absolute;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border-radius: 8px;
			padding: 6px 10px;
			text-align: center;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
			min-width: 45px;
			font-size: 12px;
			font-weight: bold;
			cursor: pointer;
			transition: all 0.2s ease;
		}
		
		.canvas-angle-box:hover {
			background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
			transform: scale(1.1);
		}
		
		.canvas-angle-box.value {
			font-size: 16px;
			font-weight: bold;
		}
		
		#canvas-fr-angle { top: 5px; right: 5px; }
		#canvas-rr-angle { bottom: 5px; right: 5px; }
		#canvas-rl-angle { bottom: 5px; left: 5px; }
		#canvas-fl-angle { top: 5px; left: 5px; }
		
		.angle-adjust-buttons {
			position: absolute;
			display: flex;
			flex-direction: column;
			gap: 2px;
			margin-left: 8px;
		}
		
		.angle-btn-up, .angle-btn-down {
			width: 20px;
			height: 16px;
			border: 1px solid #667eea;
			background: white;
			color: #667eea;
			font-weight: bold;
			cursor: pointer;
			border-radius: 3px;
			transition: all 0.1s ease;
			padding: 0;
			font-size: 12px;
			line-height: 1;
		}
		
		.angle-btn-up:hover, .angle-btn-down:hover {
			background: #667eea;
			color: white;
			transform: scale(1.1);
		}
		
		.angles-display {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 10px;
			background: white;
			padding: 10px;
			border-radius: 5px;
			border: 1px solid #ddd;
		}
		
		.angle-box {
			background: #f0f0f0;
			padding: 10px;
			border-radius: 3px;
			text-align: center;
			border-left: 4px solid #3498db;
		}
		
		.angle-label {
			font-size: 11px;
			color: #666;
			font-weight: bold;
		}
		
		.angle-value {
			font-size: 18px;
			color: #2c3e50;
			font-weight: bold;
			cursor: pointer;
			padding: 4px 8px;
			border-radius: 4px;
			transition: all 0.2s ease;
		}
		
		.angle-value:hover {
			background: #e8f0ff;
			color: #667eea;
			transform: scale(1.05);
		}
		
		.right-panel {
			flex: 0 0 300px;
		}
		
		.panel-box {
			background: #f8f9fa;
			border: 1px solid #ddd;
			border-radius: 5px;
			padding: 12px;
			margin-bottom: 15px;
		}
		
		.panel-title {
			font-weight: bold;
			color: #2c3e50;
			margin-bottom: 8px;
			font-size: 13px;
		}
		
		.error-display {
			padding: 8px;
			margin-bottom: 15px;
			background: #fff3cd;
			border: 1px solid #ffc107;
			border-radius: 5px;
			max-height: 100px;
			overflow-y: auto;
			display: none;
		}
		
		.error-display.show {
			display: block;
		}
		
		.error-message {
			color: #856404;
			font-size: 12px;
			padding: 4px 0;
			border-bottom: 1px solid #ffc10044;
		}
		
		.success-message {
			background: #d4edda;
			color: #155724;
			padding: 8px 12px;
			margin-bottom: 4px;
			border-radius: 4px;
			border-left: 4px solid #28a745;
			font-size: 12px;
		}
		
		@media (max-width: 900px) {
			.content {
				flex-direction: column;
			}
			.left-panel, .right-panel {
				flex: none;
				width: 100%;
			}
		}
	</style>
</head>
<body>
	<div class="container">
		<h1>üê≥ Honking Narwhals Team 9214</h1>
		
		<div class="status-bar">
			<div class="status">
				<div class="status-item">
					<span>WebSocket:</span>
					<span id="wsStatus">Connecting...</span>
				</div>
				<div class="status-item">
					<span>Robot:</span>
					<span id="robotStatus">-</span>
				</div>
			</div>
		</div>
		
		<div id="errorDisplay" class="error-display"></div>
		
		<div class="content">
			<!-- LEFT PANEL -->
			<div class="left-panel">
				<div class="section">
					<div class="section-title">Calibration</div>
					<button class="button btn-primary" onclick="if(isRobotEnabled) window.location.href='/calibration'; else showError('Bot must be enabled to calibrate')">üîß Calibration Wizard</button>
					<button class="button btn-primary" onclick="if(isRobotEnabled) sendCommand('align', ''); else showError('Bot must be enabled to command wheels')">‚Üí Align All</button>
				</div>
				

				<div class="section">
					<div class="section-title">Tuning</div>
					<button class="button btn-danger" id="autotuneBtn" onclick="if(isRobotEnabled) startAutotune(); else showError('Bot must be enabled to autotune')">‚öôÔ∏è Autotune PID</button>
					<button class="button btn-primary" onclick="if(isRobotEnabled) window.location.href='/history'; else showError('Bot must be enabled to view history')">üìä Tuning History</button>
				</div>
		
		<div class="section">
			<div class="section-title">üêõ Debug Mode</div>
			<button class="button" id="debugToggleBtn" onclick="toggleDebugMode()" style="background: #e74c3c; margin-bottom: 8px;">Enable Debug (Rear Right Only)</button>
			<div id="debugStatus" style="font-size: 11px; color: #666; margin-bottom: 8px;">OFF</div>
			<button class="button btn-primary" onclick="if(isRobotEnabled) sendCommand('set_wheels_direction', {front_left: 0, front_right: 0, rear_left: 0, rear_right: 0}); else showError('Bot must be enabled')" style="font-size: 11px; padding: 6px;">RR ‚Üí 0¬∞</button>
			<button class="button btn-primary" onclick="if(isRobotEnabled) sendCommand('set_wheels_direction', {front_left: 0, front_right: 0, rear_left: 0, rear_right: 45}); else showError('Bot must be enabled')" style="font-size: 11px; padding: 6px;">RR ‚Üí 45¬∞</button>
			<button class="button btn-primary" onclick="if(isRobotEnabled) sendCommand('set_wheels_direction', {front_left: 0, front_right: 0, rear_left: 0, rear_right: 90}); else showError('Bot must be enabled')" style="font-size: 11px; padding: 6px;">RR ‚Üí 90¬∞</button>
			<button class="button btn-primary" onclick="if(isRobotEnabled) sendCommand('set_wheels_direction', {front_left: 0, front_right: 0, rear_left: 0, rear_right: 180}); else showError('Bot must be enabled')" style="font-size: 11px; padding: 6px;">RR ‚Üí 180¬∞</button>
		</div>
	</div>
	
	<!-- CENTER PANEL -->
	<div class="center-panel">
		<div class="canvas-wrapper">
			<canvas id="swerveCanvas" width="320" height="320"></canvas>
					<div style="position: absolute; top: 0; left: 0; width: 320px; height: 320px; pointer-events: none;">
									<div id="canvas-fl-angle" class="canvas-angle-box value" style="pointer-events: auto;" onclick="if(isRobotEnabled) editCanvasAngle('front_left', this); else showError('Bot must be enabled to edit angles')">0¬∞</div>
						<div id="fl-btns" class="angle-adjust-buttons" style="top: 5px; left: 58px; pointer-events: auto;">
										<button class="angle-btn-up" onclick="if(isRobotEnabled) adjustAngle('front_left', 5); else showError('Bot must be enabled to adjust angles')">‚ñ≤</button>
										<button class="angle-btn-down" onclick="if(isRobotEnabled) adjustAngle('front_left', -5); else showError('Bot must be enabled to adjust angles')">‚ñº</button>
						</div>
						
									<div id="canvas-fr-angle" class="canvas-angle-box value" style="pointer-events: auto;" onclick="if(isRobotEnabled) editCanvasAngle('front_right', this); else showError('Bot must be enabled to edit angles')">0¬∞</div>
						<div id="fr-btns" class="angle-adjust-buttons" style="top: 5px; right: 58px; pointer-events: auto;">
										<button class="angle-btn-up" onclick="if(isRobotEnabled) adjustAngle('front_right', 5); else showError('Bot must be enabled to adjust angles')">‚ñ≤</button>
										<button class="angle-btn-down" onclick="if(isRobotEnabled) adjustAngle('front_right', -5); else showError('Bot must be enabled to adjust angles')">‚ñº</button>
						</div>
						
									<div id="canvas-rl-angle" class="canvas-angle-box value" style="pointer-events: auto;" onclick="if(isRobotEnabled) editCanvasAngle('rear_left', this); else showError('Bot must be enabled to edit angles')">0¬∞</div>
						<div id="rl-btns" class="angle-adjust-buttons" style="bottom: 5px; left: 58px; pointer-events: auto;">
										<button class="angle-btn-up" onclick="if(isRobotEnabled) adjustAngle('rear_left', 5); else showError('Bot must be enabled to adjust angles')">‚ñ≤</button>
										<button class="angle-btn-down" onclick="if(isRobotEnabled) adjustAngle('rear_left', -5); else showError('Bot must be enabled to adjust angles')">‚ñº</button>
						</div>
						
									<div id="canvas-rr-angle" class="canvas-angle-box value" style="pointer-events: auto;" onclick="if(isRobotEnabled) editCanvasAngle('rear_right', this); else showError('Bot must be enabled to edit angles')">0¬∞</div>
						<div id="rr-btns" class="angle-adjust-buttons" style="bottom: 5px; right: 58px; pointer-events: auto;">
										<button class="angle-btn-up" onclick="if(isRobotEnabled) adjustAngle('rear_right', 5); else showError('Bot must be enabled to adjust angles')">‚ñ≤</button>
										<button class="angle-btn-down" onclick="if(isRobotEnabled) adjustAngle('rear_right', -5); else showError('Bot must be enabled to adjust angles')">‚ñº</button>
						</div>
					</div>
				</div>
			</div>
			
			<!-- RIGHT PANEL -->
			<div class="right-panel">
				<div class="panel-box">
					<div class="panel-title">Autotune Status</div>
					<div id="autotuneStatus" style="font-size: 12px; color: #666;">Idle</div>
				</div>
				
				<div class="panel-box" id="presetsBox" style="display: none; border: 2px solid #2ecc71; background: #e8f8e8;">
					<div class="panel-title" id="presetsTitle" style="color: #27ae60;">Presets for <span id="focusedWheelName"></span></div>
					<button class="button btn-primary" onclick="if(isRobotEnabled && focusedWheel) applyPreset(0); else showError('Bot must be enabled and wheel must be focused')" title="Set focused wheel to 0¬∞">‚Üë Forward (0¬∞)</button>
					<button class="button btn-primary" onclick="if(isRobotEnabled && focusedWheel) applyPreset(270); else showError('Bot must be enabled and wheel must be focused')" title="Set focused wheel to 270¬∞">‚Üí Right (270¬∞)</button>
					<button class="button btn-primary" onclick="if(isRobotEnabled && focusedWheel) applyPreset(180); else showError('Bot must be enabled and wheel must be focused')" title="Set focused wheel to 180¬∞">‚Üì Back (180¬∞)</button>
					<button class="button btn-primary" onclick="if(isRobotEnabled && focusedWheel) applyPreset(90); else showError('Bot must be enabled and wheel must be focused')" title="Set focused wheel to 90¬∞">‚Üê Left (90¬∞)</button>
				</div>
			</div>
		</div>
	</div>
	
	<script>
		// ===== WebSocket Setup =====
		let ws = null;
		let wheelAngles = { front_left: 0, front_right: 0, rear_left: 0, rear_right: 0 };
		let focusedWheel = null;
		let updateCount = 0;
		let isRobotEnabled = false;
		let debugMode = false;
		let debugWheelOnly = 'rear_right';
		
		const WS_URL = `ws://${window.location.hostname}:${window.location.port}/ws`;
		
		function connectWebSocket() {
			console.log("[WS] Connecting to:", WS_URL);
			ws = new WebSocket(WS_URL);
			
			ws.onopen = () => {
				console.log("[WS] Connected!");
				document.getElementById("wsStatus").textContent = "Connected";
				document.getElementById("wsStatus").className = "connected";
			};
			
			ws.onmessage = (event) => {
				try {
					const data = JSON.parse(event.data);
					handleWebSocketMessage(data);
				} catch (e) {
					console.error("[WS] Parse error:", e, event.data);
					showError("WebSocket parse error: " + e.message);
				}
			};
			
			ws.onerror = (error) => {
				console.error("[WS] Error:", error);
				document.getElementById("wsStatus").textContent = "Error";
				document.getElementById("wsStatus").className = "";
				showError("WebSocket error - check browser console");
			};
			
			ws.onclose = () => {
				console.log("[WS] Closed, reconnecting...");
				document.getElementById("wsStatus").textContent = "Reconnecting...";
				document.getElementById("wsStatus").className = "";
				setTimeout(connectWebSocket, 2000);
			};
		}
		
		function updateBackgroundColor() {
			const container = document.querySelector('.container');
			container.style.background = isRobotEnabled ? 'white' : '#ff0000';
		}
		
		function sendCommand(cmd, value) {
			if (!ws || ws.readyState !== WebSocket.OPEN) {
				showError("WebSocket not connected");
				return;
			}
			
			// DEBUG MODE: Filter commands to only affect rear_right
			if (debugMode && cmd === 'set_wheels_direction') {
				console.log(`[DEBUG MODE ACTIVE] Filtering preset to only control ${debugWheelOnly}`);
				// Only send target angle for rear_right, others stay at 0
				value = {
					front_left: 0,
					front_right: 0,
					rear_left: 0,
					rear_right: value.rear_right
				};
				console.log(`[DEBUG MODE] Modified value:`, value);
			}
			
			console.log(`[WS] Sending: cmd=${cmd}, value=`, value);
			console.log(`[DEBUG] Command type: ${typeof value}, Value dump:`, JSON.stringify(value));
			
			// Special debug for wheel direction commands
			if (cmd === 'set_wheels_direction') {
				console.log(`[DEBUG] Wheel direction preset:`);
				console.log(`  Front Left: ${value.front_left}¬∞`);
				console.log(`  Front Right: ${value.front_right}¬∞`);
				console.log(`  Rear Left: ${value.rear_left}¬∞`);
				console.log(`  Rear Right: ${value.rear_right}¬∞`);
			}
			
			if (cmd === "focus") {
				focusedWheel = value;
				drawSwerve();
			}
			ws.send(JSON.stringify({ cmd, value }));
			console.log(`[DEBUG] Message sent successfully`);
		}
		
		function handleWebSocketMessage(data) {
			const type = data.type;
			
			if (type === "state") {
				// Initial state
				updateAngles(data);
			}
			else if (type === "angles") {
				updateAngles(data);
			}
			else if (type === "autotune_complete") {
				handleAutotuneComplete(data);
			}
			else if (type === "autotune_progress") {
				document.getElementById("autotuneStatus").textContent = `Tuning ${data.wheel}...`;
			}
			else if (type === "error") {
				showError(data.message);
			}
		}
		
		function updateAngles(data) {
			if (data.angles) {
				wheelAngles = data.angles;
				const elements = {
					'canvas-fl-angle': data.angles.front_left,
					'canvas-fr-angle': data.angles.front_right,
					'canvas-rl-angle': data.angles.rear_left,
					'canvas-rr-angle': data.angles.rear_right
				};
				
				for (const [id, angle] of Object.entries(elements)) {
					const el = document.getElementById(id);
					if (el && !(el instanceof HTMLInputElement)) {
						el.textContent = Math.round(angle) + "¬∞";
					}
				}
				drawSwerve();
			}
			if (data.robot_enabled !== undefined) {
				isRobotEnabled = data.robot_enabled;
				document.getElementById("robotStatus").textContent = isRobotEnabled ? "‚úì Enabled" : "‚úó Disabled";
				updateBackgroundColor();
			}
			
		}
		
		function handleAutotuneComplete(data) {
			const status = document.getElementById("autotuneStatus");
			status.innerHTML = `‚úì Complete!<br>KP=${data.kp.toFixed(6)}<br>KI=${data.ki.toFixed(6)}<br>KD=${data.kd.toFixed(6)}<br>@ ${data.battery_voltage.toFixed(2)}V`;
			status.style.color = "#2ecc71";
			document.getElementById("autotuneBtn").disabled = false;
		}
		
		function updatePresetsPanel() {
			const presetsBox = document.getElementById("presetsBox");
			const focusedWheelName = document.getElementById("focusedWheelName");
			
			if (focusedWheel) {
				presetsBox.style.display = "block";
				focusedWheelName.textContent = focusedWheel.replace('_', ' ').toUpperCase();
			} else {
				presetsBox.style.display = "none";
			}
		}
		
		function applyPreset(angle) {
			if (!focusedWheel || !isRobotEnabled) {
				showError("Bot must be enabled and wheel must be focused");
				return;
			}
			
			const angles = { front_left: wheelAngles.front_left, front_right: wheelAngles.front_right, rear_left: wheelAngles.rear_left, rear_right: wheelAngles.rear_right };
			angles[focusedWheel] = angle;
			
			sendCommand('set_wheels_direction', { angles: angles, focused_wheel: focusedWheel });
			console.log(`[PRESET] Applied ${angle}¬∞ to ${focusedWheel}`);
		}
		
		function startAutotune() {
			if (!confirm("Autotune will take ~40 seconds. Robot must not move. Continue?")) return;
			document.getElementById("autotuneBtn").disabled = true;
			document.getElementById("autotuneStatus").textContent = "Starting autotune...";
			document.getElementById("autotuneStatus").style.color = "#f39c12";
			sendCommand("autotune", "start");
		}
		
		// ===== Swerve Drawing =====
		const canvas = document.getElementById("swerveCanvas");
		const ctx = canvas.getContext("2d");
		const BOT_WIDTH = 150;
		const BOT_HEIGHT = 150;
		const WHEEL_SIZE = 12;
		const CENTER_X = canvas.width / 2;
		const CENTER_Y = canvas.height / 2;
		
		const WHEEL_POSITIONS = {
			front_left: { x: -BOT_WIDTH / 2, y: -BOT_HEIGHT / 2 },
			rear_left: { x: -BOT_WIDTH / 2, y: BOT_HEIGHT / 2 },
			front_right: { x: BOT_WIDTH / 2, y: -BOT_HEIGHT / 2 },
			rear_right: { x: BOT_WIDTH / 2, y: BOT_HEIGHT / 2 }
		};
		
		function drawSwerve() {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			
			// Grid
			ctx.strokeStyle = "#e0e0e0";
			ctx.lineWidth = 1;
			for (let i = 0; i <= canvas.width; i += 40) {
				ctx.beginPath();
				ctx.moveTo(i, 0);
				ctx.lineTo(i, canvas.height);
				ctx.stroke();
				ctx.beginPath();
				ctx.moveTo(0, i);
				ctx.lineTo(canvas.width, i);
				ctx.stroke();
			}
			
			// Robot frame
			ctx.strokeStyle = "#333";
			ctx.lineWidth = 2;
			ctx.strokeRect(CENTER_X - BOT_WIDTH / 2, CENTER_Y - BOT_HEIGHT / 2, BOT_WIDTH, BOT_HEIGHT);
			
			// Center point
			ctx.fillStyle = "#666";
			ctx.beginPath();
			ctx.arc(CENTER_X, CENTER_Y, 4, 0, 2 * Math.PI);
			ctx.fill();
			
			// Wheels
			Object.entries(WHEEL_POSITIONS).forEach(([name, pos]) => {
				const wheelX = CENTER_X + pos.x;
				const wheelY = CENTER_Y + pos.y;
				let displayAngle = wheelAngles[name] || 0;
				
				// Flip angle for all wheels since motors are wired backwards
				// and direction is corrected via speed flip in code
				displayAngle = -displayAngle;
				
				const angle = displayAngle * (Math.PI / 180) - Math.PI / 2;
				const isFocused = name === focusedWheel;
				
				// Highlight focused wheel
				if (isFocused) {
					ctx.fillStyle = "#2ecc71";
					ctx.shadowColor = "rgba(46, 204, 113, 0.8)";
					ctx.shadowBlur = 15;
				} else {
					ctx.fillStyle = "#3498db";
					ctx.shadowColor = "transparent";
				}
				
				ctx.beginPath();
				ctx.arc(wheelX, wheelY, WHEEL_SIZE, 0, 2 * Math.PI);
				ctx.fill();
				ctx.shadowColor = "transparent";
				
				ctx.strokeStyle = "white";
				ctx.lineWidth = 2;
				const arrowLen = WHEEL_SIZE * 1.5;
				ctx.beginPath();
				ctx.moveTo(wheelX, wheelY);
				ctx.lineTo(wheelX + arrowLen * Math.cos(angle), wheelY + arrowLen * Math.sin(angle));
				ctx.stroke();
				
				// Label
				ctx.fillStyle = "#333";
				ctx.font = "10px Arial";
				ctx.textAlign = "center";
				ctx.fillText(name.toUpperCase(), wheelX, wheelY + WHEEL_SIZE + 18);
			});
			
			// Click handler for wheels
			canvas.onclick = (event) => {
				const rect = canvas.getBoundingClientRect();
				const x = event.clientX - rect.left;
				const y = event.clientY - rect.top;
				
				Object.entries(WHEEL_POSITIONS).forEach(([name, pos]) => {
					const wheelX = CENTER_X + pos.x;
					const wheelY = CENTER_Y + pos.y;
					const dist = Math.sqrt((x - wheelX) ** 2 + (y - wheelY) ** 2);
					
					if (dist < WHEEL_SIZE * 2) {
						sendCommand("focus", name);
						updatePresetsPanel();
					}
				});
			};
		}
		
		// ===== Angle Adjustment with Arrow Buttons =====
		function adjustAngle(wheelName, delta) {
			console.log(`[ADJUST] wheelName=${wheelName}, delta=${delta}`);
			sendCommand("focus", wheelName);
			const currentAngle = wheelAngles[wheelName] || 0;
			let newAngle = Math.round(currentAngle) + delta;
			if (newAngle < 0) newAngle += 360;
			if (newAngle >= 360) newAngle -= 360;
			console.log(`[ADJUST] currentAngle=${currentAngle}, newAngle=${newAngle}`);
			sendCommand("set_wheel_angle", { wheel: wheelName, angle: newAngle });
		}
		
		// ===== Editable Angle Function =====
		function editCanvasAngle(wheelName, element) {
			const currentValue = parseInt(element.textContent);
			const input = document.createElement("input");
			input.type = "number";
			input.min = "0";
			input.max = "359";
			input.value = currentValue;
			input.style.width = "50px";
			input.style.textAlign = "center";
			input.style.fontSize = "16px";
			input.style.fontWeight = "bold";
			input.style.padding = "6px 10px";
			input.style.borderRadius = "8px";
			input.style.border = "2px solid #667eea";
			input.style.background = "white";
			input.style.color = "#333";
			
			input.onblur = () => submitCanvasAngle(wheelName, input.value, element, currentValue);
			
			element.replaceWith(input);
			input.focus();
			input.select();
		}
		
		function submitCanvasAngle(wheelName, newValue, element, oldValue) {
			const angle = parseInt(newValue);
			if (isNaN(angle) || angle < 0 || angle > 359) {
				showError("Angle must be 0-359¬∞");
				const valueDiv = document.createElement("div");
				const shortName = wheelName.substring(0, 1) + wheelName.substring(5, 6);
				valueDiv.id = `canvas-${shortName}-angle`;
				valueDiv.className = "canvas-angle-box value";
				valueDiv.textContent = oldValue + "¬∞";
				valueDiv.onclick = () => editCanvasAngle(wheelName, valueDiv);
				element.parentNode.replaceChild(valueDiv, element);
				return;
			}
			
			// Send command to set wheel to this angle
			sendCommand("set_wheel_angle", { wheel: wheelName, angle: angle });
			
			// Update display
			const valueDiv = document.createElement("div");
			const shortName = wheelName.substring(0, 1) + wheelName.substring(5, 6);
			valueDiv.id = `canvas-${shortName}-angle`;
			valueDiv.className = "canvas-angle-box value";
			valueDiv.textContent = angle + "¬∞";
			valueDiv.onclick = () => editCanvasAngle(wheelName, valueDiv);
			element.parentNode.replaceChild(valueDiv, element);
		}
		
		// ===== Utility Functions =====
		function showError(message) {
			console.error("[ERROR]", message);
			const display = document.getElementById("errorDisplay");
			const msg = document.createElement("div");
			msg.className = "error-message";
			msg.textContent = new Date().toLocaleTimeString() + " - " + message;
			display.appendChild(msg);
			display.classList.add("show");
			if (display.children.length > 10) {
				display.removeChild(display.firstChild);
			}
		}
		
		function showSuccess(message) {
			console.log("[SUCCESS]", message);
			const display = document.getElementById("errorDisplay");
			const msg = document.createElement("div");
			msg.className = "success-message";
			msg.textContent = new Date().toLocaleTimeString() + " - " + message;
			display.appendChild(msg);
			display.classList.add("show");
			setTimeout(() => msg.remove(), 3000);
		}
		
		function toggleDebugMode() {
			debugMode = !debugMode;
			const btn = document.getElementById('debugToggleBtn');
			const status = document.getElementById('debugStatus');
			
			if (debugMode) {
				btn.style.background = '#27ae60';
				btn.textContent = '‚èπÔ∏è Disable Debug Mode';
				status.textContent = 'ON - Only Rear Right will move';
				status.style.color = '#27ae60';
				console.log('[DEBUG MODE] ENABLED - Only rear_right wheel will respond to commands');
			} else {
				btn.style.background = '#e74c3c';
				btn.textContent = 'Enable Debug (Rear Right Only)';
				status.textContent = 'OFF';
				status.style.color = '#666';
				console.log('[DEBUG MODE] DISABLED - All wheels will respond');
			}
		}
		
		// ===== Initialize =====
		window.addEventListener("load", () => {
			drawSwerve();
			updatePresetsPanel();
			connectWebSocket();
		});
	</script>
</body>
</html>
